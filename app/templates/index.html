<!DOCTYPE html>
<html>
<head>
    <title>STLF Web UI</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<h2>Short-Term Load Forecasting</h2>

<div class="panel">
    <h3>1. Upload CSV</h3>
    <input type="file" id="fileInput">
    <button onclick="uploadFile()">Upload</button>
</div>

<div class="panel">
    <h3>2. Run Pipeline</h3>
    <button onclick="runPipeline()">Run Forecast</button>
</div>

<div id="status"></div>
<div id="download"></div>

<h3>Pipeline Flow</h3>

<div class="flowchart">
    <div class="flow-step" id="step-upload" onclick="stepClick('upload')">
        Upload CSV
    </div>
    <div class="flow-arrow">→</div>

    <div class="flow-step" id="step-ingestion" onclick="stepClick('ingestion')">
        Ingestion
    </div>
    <div class="flow-arrow">→</div>

    <div class="flow-step" id="step-preprocessing" onclick="stepClick('preprocessing')">
        Preprocessing
    </div>
    <div class="flow-arrow">→</div>

    <div class="flow-step" id="step-features" onclick="stepClick('features')">
        Feature Engineering
    </div>
    <div class="flow-arrow">→</div>

    <div class="flow-step" id="step-model" onclick="stepClick('model')">
        Model & Forecast
    </div>
    <div class="flow-arrow">→</div>

    <div class="flow-step" id="step-output" onclick="stepClick('output')">
        Output File
    </div>
</div>

<div id="step-info"></div>

<script>
function uploadFile() {
    const fileInput = document.getElementById("fileInput").files[0];
    if (!fileInput) {
        document.getElementById("status").innerText = "Please select a file first.";
        return;
    }

    const formData = new FormData();
    formData.append("file", fileInput);

    document.getElementById("status").innerText = "Uploading...";

    fetch("/upload", { method: "POST", body: formData })
        .then(r => r.json())
        .then(d => {
            document.getElementById("status").innerText = d.message;
            highlightStep("step-upload");
        })
        .catch(() => document.getElementById("status").innerText = "Upload failed.");
}

function runPipeline() {
    document.getElementById("status").innerText = "Running pipeline...";
    resetFlowHighlights();
    highlightStep("step-upload"); // assume upload done
    highlightStep("step-ingestion");

    fetch("/run", { method: "POST" })
        .then(r => r.json())
        .then(d => {
            document.getElementById("status").innerText = d.message;
            document.getElementById("download").innerHTML =
                `<a href="/download">Download Output File</a>`;

            highlightStep("step-preprocessing");
            highlightStep("step-features");
            highlightStep("step-model");
            highlightStep("step-output");
        })
        .catch(() => document.getElementById("status").innerText = "Pipeline failed.");
}

function resetFlowHighlights() {
    const steps = document.querySelectorAll(".flow-step");
    steps.forEach(s => s.classList.remove("completed"));
}

function highlightStep(id) {
    const el = document.getElementById(id);
    if (el) el.classList.add("completed");
}

function stepClick(step) {
    const info = {
        upload: "Upload CSV file with historical load and related features.",
        ingestion: "Ingestion: read CSV, basic validation, and loading into DataFrame.",
        preprocessing: "Preprocessing: cleaning, handling missing values, transformations.",
        features: "Feature Engineering: time-based features, lags, calendar, etc.",
        model: "Model & Forecast: train/apply model to generate short-term load forecast.",
        output: "Output File: forecast results saved as CSV for download."
    };
    document.getElementById("step-info").innerText = info[step] || "";
}
</script>

</body>
</html>
